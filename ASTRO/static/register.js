const API_KEY = '2021542f-8e14-40cb-9ac2-a555348e2ff1'; 
const regionSelect = document.getElementById('region');
const citySelect = document.getElementById('city');
const citiesByRegion = {
      "Пермский край": ["Пермь", "Березники", "Верещагино", "Соликамск", "Чайковский", "Кунгур"],
      "Московская область": ["Москва", "Химки", "Мытищи", "Королёв", "Подольск"],
      "Ленинградская область": ["Санкт-Петербург", "Гатчина", "Выборг", "Тосно", "Кингисепп"],
      "Алтайский край": ["Барнаул", "Бийск", "Рубцовск", "Новоалтайск", "Заринск"],
      "Амурская область": ["Благовещенск", "Свободный", "Белогорск", "Тында", "Зея"],
      "Архангельская область": ["Архангельск", "Северодвинск", "Котлас", "Новодвинск", "Коряжма"],
      "Астраханская область": ["Астрахань", "Ахтубинск", "Камызяк", "Харабали", "Знаменск"],
      "Белгородская область": ["Белгород", "Старый Оскол", "Губкин", "Шебекино", "Алексеевка"],
      "Брянская область": ["Брянск", "Клинцы", "Новозыбков", "Унеча", "Сельцо"],
      "Владимирская область": ["Владимир", "Ковров", "Муром", "Александров", "Гусь-Хрустальный"],
      "Волгоградская область": ["Волгоград", "Волжский", "Камышин", "Михайловка", "Урюпинск"],
      "Вологодская область": ["Вологда", "Череповец", "Сокол", "Великий Устюг", "Бабаево"],
      "Воронежская область": ["Воронеж", "Борисоглебск", "Лиски", "Россошь", "Острогожск"],
      "Еврейская автономная область": ["Биробиджан", "Облучье", "Ленинское", "Амурзет", "Николаевка"],
      "Забайкальский край": ["Чита", "Краснокаменск", "Борзя", "Петровск-Забайкальский", "Агинское"],
      "Ивановская область": ["Иваново", "Кинешма", "Шуя", "Тейково", "Фурманов"],
      "Иркутская область": ["Иркутск", "Братск", "Ангарск", "Усть-Илимск", "Черемхово"],
      "Кабардино-Балкарская Республика": ["Нальчик", "Прохладный", "Майский", "Тырныауз", "Баксан"],
      "Калининградская область": ["Калининград", "Советск", "Черняховск", "Гусев", "Балтийск"],
      "Калужская область": ["Калуга", "Обнинск", "Малоярославец", "Людиново", "Козельск"],
      "Камчатский край": ["Петропавловск-Камчатский", "Елизово", "Вилючинск", "Усть-Камчатск", "Оссора"],
      "Карачаево-Черкесская Республика": ["Черкесск", "Карачаевск", "Усть-Джегута", "Теберда", "Зеленчукская"],
      "Кемеровская область": ["Кемерово", "Новокузнецк", "Прокопьевск", "Ленинск-Кузнецкий", "Междуреченск"],
      "Кировская область": ["Киров", "Кирово-Чепецк", "Вятские Поляны", "Слободской", "Котельнич"],
      "Костромская область": ["Кострома", "Шарья", "Галич", "Нерехта", "Мантурово"],
      "Краснодарский край": ["Краснодар", "Сочи", "Новороссийск", "Армавир", "Анапа"],
      "Красноярский край": ["Красноярск", "Норильск", "Ачинск", "Канск", "Минусинск"],
      "Курганская область": ["Курган", "Шадринск", "Катайск", "Далматово", "Щучье"],
      "Курская область": ["Курск", "Железногорск", "Льгов", "Курчатов", "Фатеж"],
      "Липецкая область": ["Липецк", "Елец", "Грязи", "Данков", "Задонск"],
      "Магаданская область": ["Магадан", "Сусуман", "Ола", "Палатка", "Ягодное"],
      "Мурманская область": ["Мурманск", "Апатиты", "Кировск", "Североморск", "Мончегорск"],
      "Ненецкий автономный округ": ["Нарьян-Мар", "Амдерма", "Индига", "Каратайка", "Ома"],
      "Нижегородская область": ["Нижний Новгород", "Дзержинск", "Арзамас", "Саров", "Бор"],
      "Новгородская область": ["Великий Новгород", "Боровичи", "Старая Русса", "Валдай", "Чудово"],
      "Новосибирская область": ["Новосибирск", "Бердск", "Искитим", "Обь", "Куйбышев"],
      "Омская область": ["Омск", "Исилькуль", "Калачинск", "Тара", "Называевск"],
      "Оренбургская область": ["Оренбург", "Орск", "Новотроицк", "Бугуруслан", "Бузулук"],
      "Орловская область": ["Орел", "Ливны", "Мценск", "Болхов", "Новосиль"],
      "Пензенская область": ["Пенза", "Кузнецк", "Заречный", "Сердобск", "Никольск"],
      "Приморский край": ["Владивосток", "Находка", "Уссурийск", "Арсеньев", "Спасск-Дальний"],
      "Псковская область": ["Псков", "Великие Луки", "Остров", "Печоры", "Невель"],
      "Республика Адыгея": ["Майкоп", "Адыгейск", "Тахтамукай", "Яблоновский", "Энем"],
      "Республика Алтай": ["Горно-Алтайск", "Майма", "Чемал", "Кош-Агач", "Онгудай"],
      "Республика Башкортостан": ["Уфа", "Стерлитамак", "Салават", "Нефтекамск", "Октябрьский"],
      "Республика Бурятия": ["Улан-Удэ", "Северобайкальск", "Кяхта", "Гусиноозерск", "Бабушкин"],
      "Республика Дагестан": ["Махачкала", "Каспийск", "Дербент", "Хасавюрт", "Буйнакск"],
      "Республика Ингушетия": ["Магас", "Назрань", "Карабулак", "Сунжа", "Малгобек"],
      "Республика Калмыкия": ["Элиста", "Лагань", "Городовиковск", "Троицкое", "Яшкуль"],
      "Республика Карелия": ["Петрозаводск", "Костомукша", "Сортавала", "Кондопога", "Сегежа"],
      "Республика Коми": ["Сыктывкар", "Ухта", "Воркута", "Печора", "Инта"],
      "Республика Крым": ["Симферополь", "Севастополь", "Ялта", "Керчь", "Евпатория"],
      "Республика Марий Эл": ["Йошкар-Ола", "Волжск", "Козьмодемьянск", "Звенигово", "Медведево"],
      "Республика Мордовия": ["Саранск", "Рузаевка", "Ковылкино", "Темников", "Краснослободск"],
      "Республика Саха (Якутия)": ["Якутск", "Нерюнгри", "Мирный", "Ленск", "Алдан"],
      "Республика Северная Осетия — Алания": ["Владикавказ", "Беслан", "Алагир", "Моздок", "Ардон"],
      "Республика Татарстан": ["Казань", "Набережные Челны", "Альметьевск", "Нижнекамск", "Зеленодольск"],
      "Республика Тыва": ["Кызыл", "Шагонар", "Туран", "Чадан", "Ак-Довурак"],
      "Республика Хакасия": ["Абакан", "Черногорск", "Саяногорск", "Сорск", "Абаза"],
      "Ростовская область": ["Ростов-на-Дону", "Таганрог", "Шахты", "Волгодонск", "Азов"],
      "Рязанская область": ["Рязань", "Касимов", "Сасово", "Скопин", "Михайлов"],
      "Самарская область": ["Самара", "Тольятти", "Сызрань", "Нефтегорск", "Жигулёвск"],
      "Саратовская область": ["Саратов", "Энгельс", "Балаково", "Вольск", "Красноармейск"],
      "Сахалинская область": ["Южно-Сахалинск", "Корсаков", "Ноглики", "Поронайск", "Оха"],
      "Свердловская область": ["Екатеринбург", "Нижний Тагил", "Первоуральск", "Серов", "Каменск-Уральский"],
      "Смоленская область": ["Смоленск", "Вязьма", "Ярцево", "Десногорск", "Рославль"],
      "Ставропольский край": ["Ставрополь", "Пятигорск", "Кисловодск", "Невинномысск", "Ессентуки"],
      "Тамбовская область": ["Тамбов", "Мичуринск", "Уварово", "Котовск", "Жердевка"],
      "Тверская область": ["Тверь", "Ржев", "Вышний Волочек", "Кимры", "Калязин"],
      "Томская область": ["Томск", "Северск", "Асино", "Стрежевой", "Колпашево"],
      "Тульская область": ["Тула", "Новомосковск", "Щёкино", "Ефремов", "Киреевск"],
      "Тюменская область": ["Тюмень", "Тобольск", "Ишим", "Ялуторовск", "Нефтеюганск"],
      "Удмуртская Республика": ["Ижевск", "Воткинск", "Глазов", "Можга", "Сарапул"],
      "Ульяновская область": ["Ульяновск", "Димитровград", "Новоульяновск", "Инза", "Барыш"],
      "Хабаровский край": ["Хабаровск", "Комсомольск-на-Амуре", "Амурск", "Советская Гавань", "Николаевск-на-Амуре"],
      "Ханты-Мансийский автономный округ": ["Ханты-Мансийск", "Сургут", "Нижневартовск", "Когалым", "Нефтеюганск"],
      "Челябинская область": ["Челябинск", "Магнитогорск", "Златоуст", "Копейск", "Снежинск"],
      "Чеченская Республика": ["Грозный", "Аргун", "Шали", "Урус-Мартан", "Гудермез"],
      "Чувашская Республика": ["Чебоксары", "Новочебоксарск", "Мариинский Посад", "Шумерля", "Канаш"],
      "Чукотский автономный округ": ["Анадырь", "Певек", "Беринговский", "Палана", "Эгвекинот"],
      "Ямало-Ненецкий автономный округ": ["Салехард", "Ноябрьск", "Муравленко", "Лабытнанги", "Губкинский"],
      "Ярославская область": ["Ярославль", "Ростов", "Переславль-Залесский", "Тутаев", "Рыбинск"]
};
// Выбор региона
regionSelect.addEventListener('change', function () {
    const region = this.value;
    citySelect.innerHTML = '';

    if (!region || !citiesByRegion[region]) {
        citySelect.disabled = true;
        citySelect.innerHTML = '<option value="">Нет доступных городов</option>';
        return;
    }
    const cities = citiesByRegion[region];
    citySelect.disabled = false;
    citySelect.innerHTML = '<option value="">Выберите город</option>';
    cities.forEach(city => {
        const option = document.createElement('option');
        option.value = city;
        option.textContent = city;
        citySelect.appendChild(option);
    });
});

// Выбор города
citySelect.addEventListener('change', async function () {
    const city = this.value;
    const region = regionSelect.value;

    if (!city || !region) return;

    try {
        const response = await fetch(`/api/coordinates?region=${encodeURIComponent(region)}&city=${encodeURIComponent(city)}`);
        const data = await response.json();

        if (data.latitude && data.longitude) {
            console.log('Координаты города:', data.latitude, data.longitude);

            document.getElementById('birth_latitude').value = data.latitude;
            document.getElementById('birth_longitude').value = data.longitude;
        } else {
            console.error('Ошибка в данных координат:', data.error || 'неизвестная ошибка');
        }
    } catch (error) {
        console.error('Ошибка при получении координат:', error);
    }
});

// Неизвестно время рождения
document.getElementById('unknownTime').addEventListener('change', function () {
  const birthTimeInput = document.getElementById('birthTime');
  if (this.checked) {
    birthTimeInput.disabled = true;
    birthTimeInput.value = '';
  } else {
    birthTimeInput.disabled = false;
  }
});

// Подсказка что значит "не знаю точное время рождения"
const btn = document.getElementById('infoBtn');
const tooltip = document.getElementById('tooltipPopup');

btn.addEventListener('click', (e) => {
  e.stopPropagation();  
  tooltip.classList.toggle('show');
});

document.addEventListener('click', () => {
  tooltip.classList.remove('show');
});